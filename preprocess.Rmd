---
title: "R Notebook"
output: html_notebook
---


```{r}
library(readr)
library(stringr)
library(tidyr)
require(RJSONIO)
library(dplyr)
library(plyr)
require(doMC)
registerDoMC(cores=4)

```
###Read 
```{r}
foo = read_csv("yelp_academic_dataset_business_train.csv")
```

###Unlist categories
```{r}
# Find all the categories
cats = foo$categories %>% 
  strsplit(", ") %>%
  unlist() %>% 
  strsplit("\\[") %>% 
  unlist() %>% 
  strsplit("\\]") %>% 
  unlist() %>% 
  unique()
cats = cats[!is.na(cats)]
for (cat in cats){
  foo[cat] = str_detect(foo$categories, cat)
}
```
###Unlist attributes
```{r}
to_df = function(attr){
  if (is.na(attr)){
    return(data.frame("NA_Column" = c(0)))
  }
  json = attr
  json = gsub("'([a-zA-Z0-9_-]+)'", '\\1', json)
  json = gsub("([a-zA-Z0-9_-]+)", '"\\1"', json)
  json = gsub("\\[", "{", json)
  json = gsub("\\]", "}", json)
  json_list = fromJSON(json)
  while(any(vapply(json_list, function(x){length(x) > 1}, logical(1)))){
    json_list = do.call(.Primitive("c"), json_list)
  }
  json_list
  data.frame(t(data.frame(json_list)))
}
bar = mclapply(foo$attributes, to_df)
attrs = do.call(rbind.fill, bar)
attrs = select(attrs, -NA_Column)
foo = cbind(foo, attrs)
```

###Write
```{r}
write.csv(foo, file = "extended_business_train.csv")
```